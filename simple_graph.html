<!DOCTYPE html>
<meta charset="utf-8">
<title>Homework 2 Graph</title>
<style>
#menu{
	font-family:helvetica;
	color: #5077D9;
	font-size:11px;
}
  .link {
    stroke:#5077D9;
    stroke-width: 1px;
  }

  .node {
    fill: #5077D9;
    stroke: #5077D9;
    stroke-width: 1px;
  }

  .node:hover {
    fill: red;
  }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<div id = "menu">
  <form>
  Layout:
    <label><input type="radio" name="layout" value="force" checked> Force</label>
    <label><input type="radio" name="layout" value="random" > Random</label>
    <label><input type="radio" name="layout" value="radial"> Radial</label>  
    <label><input type="radio" name="layout" value="line"> 2.4.a Index Groups of Ten</label>
    <label><input type="radio" name="layout" value="time"> 2.4.b Time</label>
  </form>
  <form>
  Color:
    <label><input type="radio" name="color" value="nocolor" checked> None</label>
    <label><input type="radio" name="color" value="color_cat" > Category</label>
  </form>
  <form>
  Size:
    <label><input type="radio" name="size" value="nosize" checked> None</label>
    <label><input type="radio" name="size" value="size_cat" > Category</label>
  </form>
</div>
<script>

var width = 900,
    height = 500;

var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

var fill = d3.scale.category10();

var graph = {nodes:[], links:[]};
var commits = {}

var nb_nodes = 100, nb_cat = 10;

var link = null
var node = null

//d3.json("https://api.github.com/repos/mbostock/d3/commits?page=1&per_page=100", function(data) {
	d3.json("commits.json", function(data) {
	data.forEach(function(d,k){
		var node = {"id":d.sha, "time": d.commit.author.date, "author":d.commit.author.id, "message":d.commit.message}
		commits[node.id] = node;
	})

	data.forEach(function(d,k){
		graph.nodes.push(commits[d.sha]); //push id ot nodes array
		//console.log("there are this many parents: "+ d.parents.length);
		for(var j = 0; j < d.parents.length; j++){
			var target = commits[d.sha];
			var source = commits[d.parents[j].sha];
			if(source != null){
				var link = 	{"source":source, "target":target};
				graph.links.push(link);
			}
		}
	})

	link = svg.selectAll(".link")
	              .data(graph.links)
	              .enter().append("line")
	              .attr("class", "link")

	node = svg.selectAll(".node")
	              .data(graph.nodes)
	              .enter()
	              .append("g").attr("class", "node")
	  			/*.on("mouseover", function(d){
	  				d3.select(this)
	  				.property("original-r", function(d){
	  					d3.select(this)
	  					.attr("r")})
	  				.attr("r", "8")
	  				.append("text")
				    .text(function(d,i){return graph.nodes[i].message;})
	  				.attr("x", 100)
	  				.attr("y", 100);
	  			})
	  			.on("mouseout", function(d){
	  				d3.select(this)
	  				.attr("r", 5);})*/;

	node.append("circle")
	    .attr("r", 2.5)

	force_layout();
})

// Generate the force layout
var force = d3.layout.force()
    .size([width, height])
    .charge(-50)
    .linkDistance(10)
    .on("tick", tick)
    .on("start", function(d) {})
    .on("end", function(d) {})

function tick(d) {

  graph_update(0);
}

function random_layout() {
  
  force.stop();

  graph.nodes.forEach(function(d, i) {
    d.x = width/4 + 2*width*Math.random()/4;
    d.y = height/4 + 2*height*Math.random()/4;
  })
  
  graph_update(500);
}

function force_layout() {

 force.nodes(graph.nodes)
      .links(graph.links)
      .start();
}

function line_layout() {

  force.stop();
  
  var margin = {top: 120, right: 20, bottom: 250, left: 20};
  var scaleX = d3.scale.linear()
      .domain([0,100])
      .range([0, 800]);

  var xAxis = d3.svg.axis()
      .scale(scaleX);

  var svg = d3.select("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  svg.append("g")
      .attr("class", "x axis")
	  .attr("stroke", "#5077D9")
	  .attr("fill", "none")
	  
      .call(xAxis)
    .selectAll("text")
      .attr("y", 0)
      .attr("x", 9)
      .attr("dy", ".35em")
      .attr("transform", "rotate(90)")
      .style("text-anchor", "start")
	  .attr("font-family", "helvetica")
	  .attr("font-size", 11);
	  
  graph.nodes.forEach(function(d, i) {
   // d.y = height/2;
	d.y = (i*10)%100+20;
	d.x = i*8+20;
  })
  /*node.append("text")
  .attr("x", 5)
  .attr("dy", ".20em")
  .text(function(d,i){return graph.nodes[i].id;})
  .attr("font-family", "helvetica")
  .attr("font-size", 10)*/
  graph_update(500);
  
}
function time_layout(){
	console.log("time")
	force.stop;
	d3.select("x axis")
	.remove();
    var margin = {top: 120, right: 20, bottom: 250, left: 20};
	var t1 = new Date(2012, 0, 1),
	    t2 = new Date(2013, 0, 1),
	    t0 = d3.time.month.offset(t1, -1),
	    t3 = d3.time.month.offset(t2, +1);

	var scaleX = d3.time.scale()
	    .domain([t0, t3])
	    .range([t0, t3].map(d3.time.scale()
	      .domain([t1, t2])
	      .range([0, width])));
			
	    var xAxis = d3.svg.axis()
	        .scale(scaleX);

	    var svg = d3.select("svg")
	        .attr("width", width + margin.left + margin.right)
	        .attr("height", height + margin.top + margin.bottom)
	      .append("g")
	        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	    svg.append("g")
	        .attr("class", "x axis")
	  	  .attr("stroke", "#5077D9")
	  	  .attr("fill", "none")
	  
	        .call(xAxis)
	      .selectAll("text")
	        .attr("y", 0)
	        .attr("x", 9)
	        .attr("dy", ".35em")
	        .attr("transform", "rotate(90)")
	        .style("text-anchor", "start")
	  	  .attr("font-family", "helvetica")
	  	  .attr("font-size", 11);
		  
		  graph.nodes.forEach(function(d, i) {
		   // d.y = height/2;
			d.y = (i*10)%100+20;
			d.x = i*8+20;
		  })
		  graph_update(500);
		  
}
function line_cat_layout() {

  force.stop();

  graph.nodes.forEach(function(d, i) {
    d.y = height/2 + d.cat*20;
  })

  graph_update(500);
}

function radial_layout() {

  force.stop();

  var r = height/2;

  var arc = d3.svg.arc()
          .outerRadius(r);

  var pie = d3.layout.pie()
  .sort(function(a, b) { return a.cat - b.cat;})
          .value(function(d, i) { return 1; }); // equal share for each point

  graph.nodes = pie(graph.nodes).map(function(d, i) {
    d.innerRadius = 0;
    d.outerRadius = r;
    d.data.x = arc.centroid(d)[0]+height/2;
    d.data.y = arc.centroid(d)[1]+width/2;
    d.data.endAngle = d.endAngle; 
    d.data.startAngle = d.startAngle; 
    return d.data;
  })

  graph_update(500);
}

function category_color() {
  d3.selectAll("circle").transition().duration(500).style("fill", function(d) { return fill(d.cat); });
}

function category_size() {
  d3.selectAll("circle").transition().duration(500).attr("r", function(d) { return Math.sqrt((d.cat+1)*10); });
}

function graph_update(delay) {

  link.transition().duration(delay)
      .attr("x1", function(d) { return d.target.x; })
      .attr("y1", function(d) { return d.target.y; })
      .attr("x2", function(d) { return d.source.x; })
      .attr("y2", function(d) { return d.source.y; });

  node.transition().duration(delay)
      .attr("transform", function(d) { 
        return "translate("+d.x+","+d.y+")"; 
      });
}

d3.select("input[value=\"force\"]").on("click", force_layout);
d3.select("input[value=\"random\"]").on("click", random_layout);
d3.select("input[value=\"line\"]").on("click", line_layout);
d3.select("input[value=\"time\"]").on("click", time_layout);
d3.select("input[value=\"radial\"]").on("click", radial_layout);

d3.select("input[value=\"nocolor\"]").on("click", function() {
  d3.selectAll("circle").transition().duration(500).style("fill", "#66CC66");
})

d3.select("input[value=\"color_cat\"]").on("click", category_color);

d3.select("input[value=\"nosize\"]").on("click", function() {
  d3.selectAll("circle").transition().duration(500).attr("r", 5);
})

d3.select("input[value=\"size_cat\"]").on("click", category_size);


</script>
</body>
</html>